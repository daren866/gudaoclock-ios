name: Build GudaoClock IPA for TrollStore (iOS 15+ arm64)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest'

    - name: Install Tuist via Homebrew
      run: |
        brew update
        brew install tuist
        tuist version

    - name: Generate Project with Tuist
      run: |
        tuist generate --no-open
        echo "ç”Ÿæˆçš„é¡¹ç›®æ–‡ä»¶ï¼š"
        ls -la *.xcodeproj || echo "æœªæ‰¾åˆ°é¡¹ç›®æ–‡ä»¶"

    - name: Build Xcode Archive
      run: |
        # æŸ¥æ‰¾Tuistç”Ÿæˆçš„é¡¹ç›®æ–‡ä»¶ï¼ˆåŠ¨æ€æŸ¥æ‰¾ï¼Œç¡®ä¿å…¼å®¹æ€§ï¼‰
        PROJECT_FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -1)
        if [ -z "$PROJECT_FILE" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° .xcodeproj æ–‡ä»¶"
          exit 1
        fi
        PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
        
        # ä½¿ç”¨GudaoClockä½œä¸ºä¸»è¦Schemeåç§°
        # å¦‚æœåŠ¨æ€æŸ¥æ‰¾çš„é¡¹ç›®åä¸æ˜¯GudaoClockï¼Œæ­¤å¤„å¯å¼ºåˆ¶æŒ‡å®š
        BUILD_SCHEME="GudaoClock"
        echo "ä½¿ç”¨é¡¹ç›®: $PROJECT_NAME, Scheme: $BUILD_SCHEME"
        
        xcodebuild clean archive \
          -project "$PROJECT_NAME.xcodeproj" \
          -scheme "$BUILD_SCHEME" \
          -configuration Release \
          -archivePath "$PWD/build/GudaoClock.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -destination generic/platform=iOS \
          ENABLE_BITCODE=NO \
          ARCHS=arm64 \
          ONLY_ACTIVE_ARCH=NO \
          IPHONEOS_DEPLOYMENT_TARGET=15.0 \
          VALID_ARCHS=arm64

    - name: Verify Binary Architecture
      run: |
        ARCHIVE_PATH="$PWD/build/GudaoClock.xcarchive"
        APP_BUNDLE=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" -type d | head -1)
        if [ -z "$APP_BUNDLE" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° .app åŒ…"
          exit 1
        fi
        APP_NAME=$(basename "$APP_BUNDLE" .app)
        APP_BINARY="$APP_BUNDLE/$APP_NAME"
        
        echo "ğŸ” éªŒè¯ GudaoClock äºŒè¿›åˆ¶æ¶æ„:"
        lipo -info "$APP_BINARY"
        echo "âœ… æ¶æ„éªŒè¯å®Œæˆ"

    - name: Package & Fix for TrollStore
      id: package_ipa
      run: |
        ARCHIVE_PATH="$PWD/build/GudaoClock.xcarchive"
        APP_BUNDLE=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" -type d | head -1)
        
        if [ -z "$APP_BUNDLE" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° .app åŒ…"
          exit 1
        fi
        
        APP_NAME=$(basename "$APP_BUNDLE" .app)
        APP_BINARY="$APP_BUNDLE/$APP_NAME"
        
        echo "å¤„ç†åº”ç”¨: $APP_NAME"
        
        # 1. æ›´æ–°Info.plistæœ€ä½ç‰ˆæœ¬
        INFO_PLIST="$APP_BUNDLE/Info.plist"
        if [ -f "$INFO_PLIST" ]; then
          /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 15.0" "$INFO_PLIST" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :MinimumOSVersion string 15.0" "$INFO_PLIST"
          echo "âœ… å·²è®¾ç½®MinimumOSVersionä¸º15.0"
        fi
        
        # 2. ä¿®å¤å¯æ‰§è¡Œæƒé™
        chmod +x "$APP_BINARY"
        echo "âœ… å·²ä¿®å¤å¯æ‰§è¡Œæƒé™"
        
        # 3. ä¼ªç­¾åï¼ˆTrollStoreå¿…éœ€ï¼‰
        brew install ldid
        ldid -S "$APP_BINARY"
        echo "âœ… å·²å®Œæˆä¼ªç­¾å"
        
        # 4. æ‰“åŒ…ä¸ºIPA
        IPA_DIR="$PWD/build/ipa"
        mkdir -p "$IPA_DIR/Payload"
        cp -R "$APP_BUNDLE" "$IPA_DIR/Payload/"
        cd "$IPA_DIR"
        zip -r "../GudaoClock_iOS15_TrollStore.ipa" Payload
        
        echo "ipa_name=GudaoClock_iOS15_TrollStore.ipa" >> $GITHUB_OUTPUT
        echo "ğŸ‰ GudaoClock IPAæ‰“åŒ…å®Œæˆï¼"

    - name: Upload GudaoClock IPA
      uses: actions/upload-artifact@v4
      with:
        name: GudaoClock-iOS15-TrollStore
        path: ${{ github.workspace }}/build/GudaoClock_iOS15_TrollStore.ipa
        retention-days: 7
